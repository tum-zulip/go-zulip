/*
Zulip REST API

Testing DraftsAPIService

*/

// Code generated by OpenAPI Generator (https://openapi-generator.tech);

package zulip_test

import (
	"context"
	"fmt"
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	"github.com/tum-zulip/go-zulip/zulip"
)

func Test_DraftsAPIService(t *testing.T) {
	t.Parallel()

	t.Run("CreateDrafts", runForAllClients(t, func(t *testing.T, apiClient *zulip.Client) {
		ctx := context.Background()
		draft := createDraft(t, ctx, apiClient)
		assert.NotZero(t, draft.Id)
	}))

	t.Run("CreateSavedSnippet", runForAllClients(t, func(t *testing.T, apiClient *zulip.Client) {
		ctx := context.Background()
		snippet := createSavedSnippet(t, ctx, apiClient)
		assert.NotZero(t, snippet.SavedSnippetId)
	}))

	t.Run("DeleteDraft", runForAllClients(t, func(t *testing.T, apiClient *zulip.Client) {
		ctx := context.Background()
		draft := createDraft(t, ctx, apiClient)

		require.NotNil(t, draft.Id)

		resp := deleteDraft(t, ctx, apiClient, *draft.Id)
		assert.Equal(t, "success", resp.Result)

		draftsResp, _, err := apiClient.GetDrafts(ctx).Execute()
		require.NoError(t, err)
		require.NotNil(t, draftsResp)

		for _, inner := range draftsResp.Drafts {
			require.NotNil(t, inner.Id)
			require.NotEqual(t, inner.Id, draft.Id, "Deleted draft still present")
		}
	}))

	t.Run("DeleteSavedSnippet", runForAllClients(t, func(t *testing.T, apiClient *zulip.Client) {
		ctx := context.Background()
		snippet := createSavedSnippet(t, ctx, apiClient)

		resp := deleteSavedSnippet(t, ctx, apiClient, snippet.SavedSnippetId)
		assert.Equal(t, "success", resp.Result)

		snippetsResp, _, err := apiClient.GetSavedSnippets(ctx).Execute()
		require.NoError(t, err)
		require.NotNil(t, snippetsResp)

		for _, s := range snippetsResp.SavedSnippets {
			require.NotEqual(t, snippet.SavedSnippetId, s.Id, "Deleted snippet still present")
		}
	}))

	t.Run("EditDraft", runForAllClients(t, func(t *testing.T, apiClient *zulip.Client) {
		ctx := context.Background()
		draft := createDraft(t, ctx, apiClient)

		updatedDraft := *draft
		updatedDraft.Id = nil // ID is passed as path param, not in body
		updatedDraft.Topic = uniqueName("draft-topic")
		updatedDraft.Content = fmt.Sprintf("updated draft content %s", uniqueName("draft"))

		resp, httpRes, err := apiClient.EditDraft(ctx, *draft.Id).
			Draft(updatedDraft).
			Execute()

		require.NoError(t, err)
		require.NotNil(t, resp)
		requireStatusOK(t, httpRes)
		assert.Equal(t, "success", resp.Result)

		draftsResp, _, err := apiClient.GetDrafts(ctx).Execute()
		require.NoError(t, err)
		require.NotNil(t, draftsResp)

		found := false
		for _, d := range draftsResp.Drafts {
			require.NotNil(t, d.Id)
			if *d.Id == *draft.Id {
				found = true
				assert.Equal(t, d.Topic, updatedDraft.Topic)
				assert.Equal(t, d.Content, updatedDraft.Content)
			}
		}
		assert.True(t, found, "Updated draft not found in draft list")
	}))

	t.Run("EditSavedSnippet", runForAllClients(t, func(t *testing.T, apiClient *zulip.Client) {
		ctx := context.Background()
		snippet := createSavedSnippet(t, ctx, apiClient)

		newTitle := uniqueName("snippet-title-updated")
		newContent := fmt.Sprintf("updated content %s", uniqueName("snippet"))

		resp, httpRes, err := apiClient.EditSavedSnippet(ctx, snippet.SavedSnippetId).
			Title(newTitle).
			Content(newContent).
			Execute()

		require.NoError(t, err)
		require.NotNil(t, resp)
		requireStatusOK(t, httpRes)
		assert.Equal(t, "success", resp.Result)

		snippetsResp, _, err := apiClient.GetSavedSnippets(ctx).Execute()
		require.NoError(t, err)
		require.NotNil(t, snippetsResp)

		found := false
		for _, s := range snippetsResp.SavedSnippets {
			if s.Id == snippet.SavedSnippetId {
				found = true
				assert.Equal(t, newTitle, s.Title)
				assert.Equal(t, newContent, s.Content)
			}
		}
		assert.True(t, found, "Updated saved snippet not found in list")
	}))

	t.Run("GetDrafts", runForAllClients(t, func(t *testing.T, apiClient *zulip.Client) {
		ctx := context.Background()
		draft := createDraft(t, ctx, apiClient)

		resp, httpRes, err := apiClient.GetDrafts(ctx).Execute()

		require.NoError(t, err)
		require.NotNil(t, resp)
		requireStatusOK(t, httpRes)
		assert.GreaterOrEqual(t, len(resp.Drafts), 1)

		found := false
		for _, d := range resp.Drafts {
			require.NotNil(t, d.Id)
			if *d.Id == *draft.Id {
				found = true
				assert.Equal(t, d.Topic, draft.Topic)
				assert.Equal(t, d.Content, draft.Content)
			}
		}
		assert.True(t, found, "Created draft not found in list of drafts")
	}))

	t.Run("GetSavedSnippets", runForAllClients(t, func(t *testing.T, apiClient *zulip.Client) {
		ctx := context.Background()
		snippet := createSavedSnippet(t, ctx, apiClient)

		resp, httpRes, err := apiClient.GetSavedSnippets(ctx).Execute()

		require.NoError(t, err)
		require.NotNil(t, resp)
		requireStatusOK(t, httpRes)
		assert.GreaterOrEqual(t, len(resp.SavedSnippets), 1)

		found := false
		for _, s := range resp.SavedSnippets {
			if s.Id == snippet.SavedSnippetId {
				found = true
			}
		}
		assert.True(t, found, "Created saved snippet not found in list")
	}))
}

func createDraft(t *testing.T, ctx context.Context, apiClient *zulip.Client) *zulip.Draft {
	t.Helper()

	userId := getOwnUserId(t, apiClient)
	_, streamId := createRandomChannel(t, apiClient, userId)

	draft := &zulip.Draft{
		Type:    "stream",
		To:      []int64{streamId},
		Topic:   uniqueName("draft-topic"),
		Content: fmt.Sprintf("draft content %s", uniqueName("draft")),
		// in the past to avoid any clock skew issues
		Timestamp: time.Now().Add(-1 * time.Minute),
	}

	resp, httpRes, err := apiClient.CreateDrafts(ctx).
		Drafts([]zulip.Draft{*draft}).
		Execute()

	require.NoError(t, err)
	require.NotNil(t, resp)
	requireStatusOK(t, httpRes)
	require.NotEmpty(t, resp.Ids)

	draftId := resp.Ids[0]
	require.Greater(t, draftId, int64(0))
	draft.Id = &draftId

	return draft
}

func deleteDraft(t *testing.T, ctx context.Context, apiClient *zulip.Client, draftId int64) *zulip.Response {
	t.Helper()

	resp, httpRes, err := apiClient.DeleteDraft(ctx, draftId).Execute()

	require.NoError(t, err)
	require.NotNil(t, resp)
	requireStatusOK(t, httpRes)

	return resp
}

func createSavedSnippet(t *testing.T, ctx context.Context, apiClient *zulip.Client) *zulip.CreateSavedSnippetResponse {
	t.Helper()

	title := uniqueName("snippet-title")
	content := fmt.Sprintf("snippet content %s", uniqueName("snippet"))

	resp, httpRes, err := apiClient.CreateSavedSnippet(ctx).
		Title(title).
		Content(content).
		Execute()

	require.NoError(t, err)
	require.NotNil(t, resp)
	requireStatusOK(t, httpRes)

	return resp
}

func deleteSavedSnippet(t *testing.T, ctx context.Context, apiClient *zulip.Client, savedSnippetId int64) *zulip.Response {
	t.Helper()

	resp, httpRes, err := apiClient.DeleteSavedSnippet(ctx, savedSnippetId).Execute()

	require.NoError(t, err)
	require.NotNil(t, resp)
	requireStatusOK(t, httpRes)

	return resp
}
